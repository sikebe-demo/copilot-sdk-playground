name: Test

on:
  pull_request:
    branches: [ main ]
  workflow_run:
    workflows: ["Update CLI Versions"]
    types: [completed]

jobs:
  # workflow_run „Éà„É™„Ç¨„ÉºÊôÇ„Å´PRÁï™Âè∑„ÇíÂèñÂæó„Åó„ÄÅ„ÉÜ„Çπ„ÉàÈñãÂßã„Çí„Ç≥„É°„É≥„Éà
  notify-test-start:
    name: Notify Test Start
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success'
    outputs:
      pr_number: ${{ steps.get-pr.outputs.pr_number }}
      branch_name: ${{ steps.get-pr.outputs.branch_name }}
    permissions:
      pull-requests: write
      actions: read

    steps:
    - name: Download PR info artifact
      id: download
      uses: actions/github-script@v8
      with:
        script: |
          const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
            owner: context.repo.owner,
            repo: context.repo.repo,
            run_id: context.payload.workflow_run.id,
          });

          const prInfoArtifact = artifacts.data.artifacts.find(a => a.name === 'pr-info');
          if (!prInfoArtifact) {
            console.log('No pr-info artifact found');
            return;
          }

          const download = await github.rest.actions.downloadArtifact({
            owner: context.repo.owner,
            repo: context.repo.repo,
            artifact_id: prInfoArtifact.id,
            archive_format: 'zip',
          });

          const fs = require('fs');
          const path = require('path');
          const temp = '${{ runner.temp }}/pr-info';
          if (!fs.existsSync(temp)) {
            fs.mkdirSync(temp, { recursive: true });
          }
          fs.writeFileSync(path.join(temp, 'pr-info.zip'), Buffer.from(download.data));

    - name: Extract PR info
      id: get-pr
      run: |
        if [ -f "${{ runner.temp }}/pr-info/pr-info.zip" ]; then
          unzip -o "${{ runner.temp }}/pr-info/pr-info.zip" -d "${{ runner.temp }}/pr-info"
          PR_NUMBER=$(cat "${{ runner.temp }}/pr-info/pr_number")
          BRANCH_NAME=$(cat "${{ runner.temp }}/pr-info/branch_name")
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "Found PR #$PR_NUMBER on branch $BRANCH_NAME from artifact"
        else
          echo "No PR info artifact found"
          echo "pr_number=" >> $GITHUB_OUTPUT
          echo "branch_name=" >> $GITHUB_OUTPUT
        fi

    - name: Comment test starting
      if: steps.get-pr.outputs.pr_number != ''
      env:
        GH_TOKEN: ${{ github.token }}
        PR_NUMBER: ${{ steps.get-pr.outputs.pr_number }}
        REPO: ${{ github.repository }}
      run: |
        gh pr comment "$PR_NUMBER" \
          --repo "$REPO" \
          --body "## üîÑ Tests Running

        Tests have been triggered by the CLI version update workflow.

        | Item | Value |
        |------|-------|
        | Workflow Run | [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |
        | Triggered by | Update CLI Versions workflow |

        Results will be posted here when complete."

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [notify-test-start]
    # pull_request „ÅÆÂ†¥Âêà„ÅØÂ∏∏„Å´ÂÆüË°å„ÄÅworkflow_run „ÅÆÂ†¥Âêà„ÅØ notify-test-start „ÅåÊàêÂäü„Åó„ÅüÂ†¥Âêà„ÅÆ„Åø
    if: always() && (github.event_name == 'pull_request' || needs.notify-test-start.result == 'success')

    steps:
    - name: Checkout
      uses: actions/checkout@v6
      with:
        # workflow_run „ÅÆÂ†¥Âêà„ÅØ PR „Éñ„É©„É≥„ÉÅ„Çí„ÉÅ„Çß„ÉÉ„ÇØ„Ç¢„Ç¶„Éà
        ref: ${{ needs.notify-test-start.outputs.branch_name || github.ref }}

    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        global-json-file: './global.json'

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --no-restore

    - name: Run Unit Tests with Coverage
      run: |
        dotnet test src/CopilotSdkPlayground.UnitTests/CopilotSdkPlayground.UnitTests.csproj \
          --no-build \
          --verbosity normal \
          --collect:"XPlat Code Coverage" \
          --results-directory ./coverage

    - name: Install ReportGenerator
      run: dotnet tool install -g dotnet-reportgenerator-globaltool

    - name: Generate Coverage Report
      run: |
        reportgenerator \
          -reports:./coverage/**/coverage.cobertura.xml \
          -targetdir:./coverage/report \
          -reporttypes:"MarkdownSummaryGithub;Cobertura"

    - name: Add Coverage to Job Summary
      run: cat ./coverage/report/SummaryGithub.md >> $GITHUB_STEP_SUMMARY

    - name: Upload Coverage Report
      uses: actions/upload-artifact@v6
      with:
        name: coverage-report
        path: |
          coverage/**/coverage.cobertura.xml
          coverage/report/
        retention-days: 5

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [notify-test-start, unit-tests]
    # pull_request „ÅÆÂ†¥Âêà„ÅØ unit-tests „ÅåÊàêÂäü„Åó„ÅüÂ†¥Âêà„Å´ÂÆüË°å„ÄÅworkflow_run „ÅÆÂ†¥Âêà„ÅØ notify-test-start „Å® unit-tests „ÅåÊàêÂäü„Åó„ÅüÂ†¥Âêà„Å´ÂÆüË°å
    if: always() && needs.unit-tests.result == 'success' && (needs.notify-test-start.result == 'skipped' || needs.notify-test-start.result == 'success')

    steps:
    - name: Checkout
      uses: actions/checkout@v6
      with:
        # workflow_run „ÅÆÂ†¥Âêà„ÅØ PR „Éñ„É©„É≥„ÉÅ„Çí„ÉÅ„Çß„ÉÉ„ÇØ„Ç¢„Ç¶„Éà
        ref: ${{ needs.notify-test-start.outputs.branch_name || github.ref }}

    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        global-json-file: './global.json'

    - name: Read versions
      id: versions
      run: |
        echo "gh_cli=$(jq -r '.gh_cli_version' .github/versions.json)" >> $GITHUB_OUTPUT
        echo "copilot_cli=$(jq -r '.copilot_cli_version' .github/versions.json)" >> $GITHUB_OUTPUT

    - name: Setup GitHub CLI
      env:
        GH_CLI_VERSION: ${{ steps.versions.outputs.gh_cli }}
      run: |
        # https://github.com/cli/cli/releases
        wget -q "https://github.com/cli/cli/releases/download/v${GH_CLI_VERSION}/gh_${GH_CLI_VERSION}_linux_amd64.deb" -O gh.deb
        sudo dpkg -i gh.deb
        gh --version

    - name: Setup Copilot CLI
      env:
        COPILOT_CLI_VERSION: ${{ steps.versions.outputs.copilot_cli }}
      run: |
        # https://github.com/github/copilot-cli/releases
        wget -q "https://github.com/github/copilot-cli/releases/download/v${COPILOT_CLI_VERSION}/copilot-linux-x64.tar.gz" -O copilot-cli.tar.gz
        sudo tar -xzf copilot-cli.tar.gz -C /usr/local/bin
        copilot --version

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --no-restore

    - name: Run E2E Tests
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
      run: |
        dotnet test src/CopilotSdkPlayground.E2ETests/CopilotSdkPlayground.E2ETests.csproj \
          --no-build \
          --verbosity normal \
          --logger "console;verbosity=detailed" \
          --logger "trx;LogFileName=e2e-results.trx" \
          --results-directory ./e2e-results

    - name: Add E2E Test Results to Job Summary
      if: always()
      run: |
        echo "## üß™ E2E Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -f "./e2e-results/e2e-results.trx" ]; then
          # Parse TRX file for basic results
          TOTAL=$(grep -oP 'total="\K[^"]+' ./e2e-results/e2e-results.trx | head -1)
          PASSED=$(grep -oP 'passed="\K[^"]+' ./e2e-results/e2e-results.trx | head -1)
          FAILED=$(grep -oP 'failed="\K[^"]+' ./e2e-results/e2e-results.trx | head -1)
          SKIPPED=$(grep -oP 'skipped="\K[^"]+' ./e2e-results/e2e-results.trx | head -1)

          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total | ${TOTAL:-0} |" >> $GITHUB_STEP_SUMMARY
          echo "| ‚úÖ Passed | ${PASSED:-0} |" >> $GITHUB_STEP_SUMMARY
          echo "| ‚ùå Failed | ${FAILED:-0} |" >> $GITHUB_STEP_SUMMARY
          echo "| ‚è≠Ô∏è Skipped | ${SKIPPED:-0} |" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ö†Ô∏è No test results file found" >> $GITHUB_STEP_SUMMARY
        fi

  # workflow_run „Éà„É™„Ç¨„ÉºÊôÇ„Å´„ÉÜ„Çπ„ÉàÁµêÊûú„ÇíPR„Å´„Ç≥„É°„É≥„Éà
  notify-test-result:
    name: Notify Test Result
    runs-on: ubuntu-latest
    needs: [notify-test-start, unit-tests, e2e-tests]
    if: always() && github.event_name == 'workflow_run' && needs.notify-test-start.outputs.pr_number != ''
    permissions:
      pull-requests: write

    steps:
    - name: Comment test result
      env:
        GH_TOKEN: ${{ github.token }}
        PR_NUMBER: ${{ needs.notify-test-start.outputs.pr_number }}
      run: |
        UNIT_RESULT="${{ needs.unit-tests.result }}"
        E2E_RESULT="${{ needs.e2e-tests.result }}"

        # ÁµêÊûú„Å´Âøú„Åò„ÅüÁµµÊñáÂ≠ó„Å®„Çπ„ÉÜ„Éº„Çø„Çπ
        if [ "$UNIT_RESULT" == "success" ]; then
          UNIT_EMOJI="‚úÖ"
          UNIT_STATUS="Passed"
        elif [ "$UNIT_RESULT" == "failure" ]; then
          UNIT_EMOJI="‚ùå"
          UNIT_STATUS="Failed"
        elif [ "$UNIT_RESULT" == "skipped" ]; then
          UNIT_EMOJI="‚è≠Ô∏è"
          UNIT_STATUS="Skipped"
        else
          UNIT_EMOJI="‚ö†Ô∏è"
          UNIT_STATUS="$UNIT_RESULT"
        fi

        if [ "$E2E_RESULT" == "success" ]; then
          E2E_EMOJI="‚úÖ"
          E2E_STATUS="Passed"
        elif [ "$E2E_RESULT" == "failure" ]; then
          E2E_EMOJI="‚ùå"
          E2E_STATUS="Failed"
        elif [ "$E2E_RESULT" == "skipped" ]; then
          E2E_EMOJI="‚è≠Ô∏è"
          E2E_STATUS="Skipped"
        else
          E2E_EMOJI="‚ö†Ô∏è"
          E2E_STATUS="$E2E_RESULT"
        fi

        # ÂÖ®‰Ωì„ÅÆÁµêÊûú
        if [ "$UNIT_RESULT" == "success" ] && [ "$E2E_RESULT" == "success" ]; then
          OVERALL_EMOJI="‚úÖ"
          OVERALL_TITLE="Tests Passed"
        else
          OVERALL_EMOJI="‚ùå"
          OVERALL_TITLE="Tests Failed"
        fi

        gh pr comment "$PR_NUMBER" \
          --repo ${{ github.repository }} \
          --body "## ${OVERALL_EMOJI} ${OVERALL_TITLE}

        Tests triggered by the CLI version update workflow have completed.

        | Test Suite | Result |
        |------------|--------|
        | Unit Tests | ${UNIT_EMOJI} ${UNIT_STATUS} |
        | E2E Tests | ${E2E_EMOJI} ${E2E_STATUS} |

        [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
