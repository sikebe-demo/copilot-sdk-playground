name: Test

on:
  pull_request:
    branches: [ main ]

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        global-json-file: './global.json'

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --no-restore

    - name: Run Unit Tests with Coverage
      run: |
        dotnet test src/CopilotSdkPlayground.UnitTests/CopilotSdkPlayground.UnitTests.csproj \
          --no-build \
          --verbosity normal \
          --collect:"XPlat Code Coverage" \
          --results-directory ./coverage

    - name: Install ReportGenerator
      run: dotnet tool install -g dotnet-reportgenerator-globaltool

    - name: Generate Coverage Report
      run: |
        reportgenerator \
          -reports:./coverage/**/coverage.cobertura.xml \
          -targetdir:./coverage/report \
          -reporttypes:"MarkdownSummaryGithub;Cobertura"

    - name: Add Coverage to Job Summary
      run: cat ./coverage/report/SummaryGithub.md >> $GITHUB_STEP_SUMMARY

    - name: Upload Coverage Report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: |
          coverage/**/coverage.cobertura.xml
          coverage/report/
        retention-days: 5

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        global-json-file: './global.json'

    - name: Read versions
      id: versions
      run: |
        echo "gh_cli=$(jq -r '.gh_cli_version' .github/versions.json)" >> $GITHUB_OUTPUT
        echo "copilot_cli=$(jq -r '.copilot_cli_version' .github/versions.json)" >> $GITHUB_OUTPUT

    - name: Setup GitHub CLI
      env:
        GH_CLI_VERSION: ${{ steps.versions.outputs.gh_cli }}
      run: |
        # https://github.com/cli/cli/releases
        wget -q "https://github.com/cli/cli/releases/download/v${GH_CLI_VERSION}/gh_${GH_CLI_VERSION}_linux_amd64.deb" -O gh.deb
        sudo dpkg -i gh.deb
        gh --version

    - name: Setup Copilot CLI
      env:
        COPILOT_CLI_VERSION: ${{ steps.versions.outputs.copilot_cli }}
      run: |
        # https://github.com/github/copilot-cli/releases
        wget -q "https://github.com/github/copilot-cli/releases/download/v${COPILOT_CLI_VERSION}/copilot-linux-x64.tar.gz" -O copilot-cli.tar.gz
        sudo tar -xzf copilot-cli.tar.gz -C /usr/local/bin
        copilot --version

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --no-restore

    - name: Run E2E Tests
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
      run: |
        dotnet test src/CopilotSdkPlayground.E2ETests/CopilotSdkPlayground.E2ETests.csproj \
          --no-build \
          --verbosity normal \
          --logger "trx;LogFileName=e2e-results.trx" \
          --results-directory ./e2e-results

    - name: Add E2E Test Results to Job Summary
      if: always()
      run: |
        echo "## ðŸ§ª E2E Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -f "./e2e-results/e2e-results.trx" ]; then
          # Parse TRX file for basic results
          TOTAL=$(grep -oP 'total="\K[^"]+' ./e2e-results/e2e-results.trx | head -1)
          PASSED=$(grep -oP 'passed="\K[^"]+' ./e2e-results/e2e-results.trx | head -1)
          FAILED=$(grep -oP 'failed="\K[^"]+' ./e2e-results/e2e-results.trx | head -1)
          SKIPPED=$(grep -oP 'skipped="\K[^"]+' ./e2e-results/e2e-results.trx | head -1)

          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total | ${TOTAL:-0} |" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… Passed | ${PASSED:-0} |" >> $GITHUB_STEP_SUMMARY
          echo "| âŒ Failed | ${FAILED:-0} |" >> $GITHUB_STEP_SUMMARY
          echo "| â­ï¸ Skipped | ${SKIPPED:-0} |" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ No test results file found" >> $GITHUB_STEP_SUMMARY
        fi
